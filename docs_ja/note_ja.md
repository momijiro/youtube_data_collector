# 実用に向けて

このドキュメントでは、YouTube API関係の知識・本コードの構成など、実用時に活かせそうな内容を説明します。

## 1日の API 使用上限（quota）について
YouTube APIには「quota」というチャージの概念があり、1日あたり10,000 quota与えられています ([公式: API概要](https://developers.google.com/youtube/v3/getting-started?hl=ja))。 ただし、`mode`ごとに消費量が異なります。
|`mode` |1リクエストあたり消費量 |[公式サイト](https://developers.google.com/youtube/v3/determine_quota_cost?hl=ja)での記載方法|1日あたりの最大取得数(※)
|---|---|---|---|
|`'movie'`  |100 quota  |`検索-list`|100年(月・日)分の動画|
|`'comment'`|1 quota  |`コメントスレッド-list`|10,000動画のコメント|
|`'stats'`|1 quota  |`動画-list`|10,000動画の統計量|

#### この仕組みにより、注意すべき点は2つあります。

1. <u>**`movie`モードでは、同じ期間でも指定の仕方によって消費量が変わる**</u>
    
    　本ライブラリで年・月・日を指定できる仕様にしているのは、なるべく大きい単位で実行し、quota効率を上げるためです。例えば、2020年から2022年の3年分の動画データを取得する際の消費quotaは以下のようになり、同じ期間でも大きく変わることが分かります。
    |`start`|`end`|リクエスト数|最低quota消費量 (※)|取得にかかる最短日数|
    |---|---|---|---|---|
    |`2020`  |`2022`|`1*3=3`回|`100*3=300` quota|1日|
    |`2020-01`|`2022-12` |`12*3=36`回|`100*36=3,600` quota|1日|
    |`2020-01-01`|`2022-12-31` |`365*3=1095`回|`100*1095=11万` quota|11日|
    

2. <u>**検索でヒットするデータ数は、検索条件によって大きく異なる**</u>

    　例えば、レシピ動画を探そうとしたとき、条件を絞り込んだほうがヒット数は少なくなることは容易に想像できると思います。以下の`レシピ`のようにヒット数が1,000件もあると、1回のリクエストで全てのデータを収集できず、同じ条件で何度もリクエストする必要があります。
    |`query`|ヒット数（イメージ）|再リクエスト|
    |---|---|---|
    |`レシピ`  |1,000|あり|
    |`レシピ AND キャベツ AND 豚肉 AND 時短 `|30|なし|
    


このように、大量のデータを収集するためにはquota効率が重要になります。続いて「どれくらいで再リクエストするのか？」を説明します。

※ 1日あたりの「最大取得数」、1リクエストあたりの「最低quota消費量」は、再リクエストがない場合の取得数・消費quotaであることを意味しています。

## 再リクエストについて
　前章でも述べましたが、ヒット数が多い場合、1回のリクエストで全てを取得することはできません。1回のリクエストで取得できるデータ数( `maxResults` )は50ですが、50件を超える結果はざらにあります([公式: Search関数](https://developers.google.com/youtube/v3/docs/search/list?hl=ja))。
そこで、50件を超える時には「`PageToken`」というもので「まだ続くよ」とAPIが教えてくれます( Twitter API等でも同様の仕組みがあると思います)。

　本ライブラリではその仕組みを用いて、`PageToken`がある限り再リクエストする仕様としています。 例えば、先程の「レシピ」の例では、ヒットする動画数が1,000件なので、合計1000/50=20より20回リクエストを行います。本ライブラリでは、リクエスト回数(`request_count`)を表示するようにしているので、参考にしてみてください。


## quotaは増やせないか?
　quotaの一日の上限は `10,000quota` (動画取得リクエスト100回分、コメント10,000回分)です。この制限内でなるべく多くのデータを収集するため、本ライブラリではquota効率を重視し作成しています。

一方で、quotaを増やせないの？と思う方はいらっしゃると思います。答えはYesで、YouTubeに申請フォームを出し承認されれば増やせるようなので、詳しくは公式やその他の方の記事をご参照ください。しかし僕の場合は以下の3点から結局上限解除はしていません。
- 意外とステップが面倒くさい
- 上限解除に関する情報量があまり多くない
- 使用するquota数を申請するために本ライブラリを実装したら、自身の研究ではデータ数的に不要と気づいた

研究・サービス内容によっては上限解除申請をしたほうが良い場合も多々あると思いますので、本記事がその判断の一助となれば幸いです。

## `mode` による違いまとめ
ここまでのまとめとして、各モードの違いを表に示します。

| `mode`    | `movie`              | `comment`          | `stats`           |
|-----------|----------------------|--------------------|-------------------|
| `args`で指定 | `start`, `end`, <br>`query`, `channel_id` | `video_id_list` | `video_id_list`   |
| アウトプット    | 動画のメタデータ | 動画のコメント   | 動画の統計量データ  |
|実行タイミング|最初|`movie`実行後|`movie`実行後|
| 保存フォルダ       | `output/movie`     | `output/comment`   | `output/stats` |
| 保存名 (例)      | `キーワード_2010_2010.csv`     | `comment_lastvideoid.csv`   | `stats_lastvideoid.csv`|
| リクエスト数    | `n` 回以上 (※1,2) | `video_id` 回以上 (※1)  | `video_id` 回      |
|1リクエストの消費quota| 100 | 1 | 1 |


※1：再リクエストがない場合を「最低リクエスト数」とする  
※2：n年・n月・n日というように、各単位×nの期間で収集したとする

### 本コードのディレクトリ構成
```
youtube_data_collector
├── docs                # ライブラリの実行に関係する文書まとめ (英語)
│   ├── note.md         # 実行に関わる補足・注意点等
│   └── usage.md        # 詳しい使用方法
├── docs_ja             # ライブラリの実行に関係する文書まとめ (日本語)
│   ├── note_ja.md
│   └── usage_ja.md
├── LICENSE             # ライセンス
├── README.md           # 概要
├── requirements.txt    # 依存関係
├── setup.py            # セットアップ
└── ytdc
    ├── __init__.py     # 初期化
    └── ytdc.py         # メインコード
```

# 最後に
　長くなりましたが、ここまで読んでくださり、ありがとうございます。
このライブラリが少しでも皆さんのお役に立てると幸いです。もし良かったら記事のいいね、GitHubのStar等くださると励みになります。

最後に、注意点を述べさせていただきます。  
- 本コードは、2023年12月時点で実装したものです。必要に応じて最新の情報を確認してください。([公式サイト](https://developers.google.com/youtube/v3/getting-started?hl=ja))
- APIキーの取得・本ライブラリの使用等による損失・損害については、一切責任を負いかねますので、公式の情報を確認しつつ自己責任で行ってください。
- 問題・不明点等ありましたら、お気軽にお問い合わせください。

ここまでお付き合いいただきありがとうございました！ 
連絡先: [X(Twitter)](https://twitter.com/kanure24)
